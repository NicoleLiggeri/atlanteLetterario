<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Theme</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="style.css" />
  <script src="//unpkg.com/globe.gl"></script>
</head>
<body>
  <div id="app" class="one-column">
    <header>
      <div>L'Atlante dei temi letterari</div>
      <div id="search-container">
        <input id="search-input" type="text" placeholder="Digita un tema..." />
        <ul id="suggestions-list"></ul>
        <button id="search-button">Cerca</button>
      </div>
    </header>
    
    <div id="viz"></div>
    
    <footer>
      <p>2025 Atlante dei Temi Letterari</p>
    </footer>
  </div>

  <script>
    let currentView = "initial"; 

    function setViewState(newState, extraData = null) {
      currentView = newState;
      sessionStorage.setItem("viewState", JSON.stringify({ state: newState, data: extraData }));
    }

    const savedState = sessionStorage.getItem("viewState");
    if (savedState) {
      const { state, data } = JSON.parse(savedState);
      currentView = state;
    }

    function createBackButton(container) {
      const backButton = document.createElement("button");
      backButton.className = "back-button";
      backButton.textContent = "â—€ Indietro";
      backButton.style.marginBottom = "20px";
      backButton.addEventListener("click", () => {
        if (document.referrer && document.referrer.includes("hierarchy.html")) {
          window.location.href = "hierarchy.html";
          return;
        }
        switch (currentView) {
          case "theme":
            setViewState("slice");
            alert("Tornando alla vista della fetta...");
            break;
          case "slice":
            setViewState("initial");
            alert("Tornando alla vista iniziale (grafo radiale)...");
            break;
          default:
            window.location.href = "hierarchy.html";
            break;
        }
      });
      container.appendChild(backButton);
    }

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const themeParam = getQueryParam("theme");
    if (themeParam) {
      document.getElementById("search-input").value = themeParam;
      setViewState("initial", { query: themeParam });
      createLinearDendrogram(themeParam, document.getElementById("viz"));
    }

    document.getElementById("search-button").addEventListener("click", () => {
      const rawInput = document.getElementById("search-input").value.trim();
      if (!rawInput) {
        alert("Inserisci un tema!");
        return;
      }
      const searchTerm = rawInput.charAt(0).toUpperCase() + rawInput.slice(1).toLowerCase();
      window.location.href = "theme.html?theme=" + encodeURIComponent(searchTerm);
    });
  </script>
</body>
</html>
